!function(a){a.widget("mjs.nestedSortable",a.extend({},a.ui.sortable.prototype,{options:{tabSize:20,disableNesting:"mjs-nestedSortable-no-nesting",errorClass:"mjs-nestedSortable-error",doNotClear:!1,listType:"ol",maxLevels:0,protectRoot:!1,rootID:null,rtl:!1,isAllowed:function(a,o){return!0}},_create:function(){if(this.element.data("sortable",this.element.data("nestedSortable")),!this.element.is(this.options.listType))throw new Error("nestedSortable: Please check the listType option is set to your actual list type");return a.ui.sortable.prototype._create.apply(this,arguments)},destroy:function(){return this.element.removeData("nestedSortable").unbind(".nestedSortable"),a.ui.sortable.prototype.destroy.apply(this,arguments)},_mouseDrag:function(o){this.position=this._generatePosition(o),this.positionAbs=this._convertPositionTo("absolute"),this.lastPositionAbs||(this.lastPositionAbs=this.positionAbs);var i=this.options;if(this.options.scroll){var e=!1;this.scrollParent[0]!=document&&"HTML"!=this.scrollParent[0].tagName?(this.overflowOffset.top+this.scrollParent[0].offsetHeight-o.pageY<i.scrollSensitivity?this.scrollParent[0].scrollTop=e=this.scrollParent[0].scrollTop+i.scrollSpeed:o.pageY-this.overflowOffset.top<i.scrollSensitivity&&(this.scrollParent[0].scrollTop=e=this.scrollParent[0].scrollTop-i.scrollSpeed),this.overflowOffset.left+this.scrollParent[0].offsetWidth-o.pageX<i.scrollSensitivity?this.scrollParent[0].scrollLeft=e=this.scrollParent[0].scrollLeft+i.scrollSpeed:o.pageX-this.overflowOffset.left<i.scrollSensitivity&&(this.scrollParent[0].scrollLeft=e=this.scrollParent[0].scrollLeft-i.scrollSpeed)):(o.pageY-a(document).scrollTop()<i.scrollSensitivity?e=a(document).scrollTop(a(document).scrollTop()-i.scrollSpeed):a(window).height()-(o.pageY-a(document).scrollTop())<i.scrollSensitivity&&(e=a(document).scrollTop(a(document).scrollTop()+i.scrollSpeed)),o.pageX-a(document).scrollLeft()<i.scrollSensitivity?e=a(document).scrollLeft(a(document).scrollLeft()-i.scrollSpeed):a(window).width()-(o.pageX-a(document).scrollLeft())<i.scrollSensitivity&&(e=a(document).scrollLeft(a(document).scrollLeft()+i.scrollSpeed))),e!==!1&&a.ui.ddmanager&&!i.dropBehaviour&&a.ui.ddmanager.prepareOffsets(this,o)}this.positionAbs=this._convertPositionTo("absolute");var n=this.placeholder.offset().top;this.options.axis&&"y"==this.options.axis||(this.helper[0].style.left=this.position.left+"px"),this.options.axis&&"x"==this.options.axis||(this.helper[0].style.top=this.position.top+"px");for(var t=this.items.length-1;t>=0;t--){var c=this.items[t],r=c.item[0],l=this._intersectsWithPointer(c);if(l&&r!=this.currentItem[0]&&this.placeholder[1==l?"next":"prev"]()[0]!=r&&!a.contains(this.placeholder[0],r)&&("semi-dynamic"==this.options.type?!a.contains(this.element[0],r):!0)){if(a(r).mouseenter(),this.direction=1==l?"down":"up","pointer"!=this.options.tolerance&&!this._intersectsWithSides(c))break;a(r).mouseleave(),this._rearrange(o,c),this._clearEmpty(r),this._trigger("change",o,this._uiHash());break}}var s=this.placeholder[0].parentNode.parentNode&&a(this.placeholder[0].parentNode.parentNode).closest(".ui-sortable").length?a(this.placeholder[0].parentNode.parentNode):null,f=this._getLevel(this.placeholder),p=this._getChildLevels(this.helper),d=this.placeholder[0].previousSibling?a(this.placeholder[0].previousSibling):null;if(null!=d)for(;"li"!=d[0].nodeName.toLowerCase()||d[0]==this.currentItem[0]||d[0]==this.helper[0];){if(!d[0].previousSibling){d=null;break}d=a(d[0].previousSibling)}var h=this.placeholder[0].nextSibling?a(this.placeholder[0].nextSibling):null;if(null!=h)for(;"li"!=h[0].nodeName.toLowerCase()||h[0]==this.currentItem[0]||h[0]==this.helper[0];){if(!h[0].nextSibling){h=null;break}h=a(h[0].nextSibling)}var u=document.createElement(i.listType);return this.beyondMaxLevels=0,null!=s&&null==h&&(i.rtl&&this.positionAbs.left+this.helper.outerWidth()>s.offset().left+s.outerWidth()||!i.rtl&&this.positionAbs.left<s.offset().left)?(s.after(this.placeholder[0]),this._clearEmpty(s[0]),this._trigger("change",o,this._uiHash())):null!=d&&(i.rtl&&this.positionAbs.left+this.helper.outerWidth()<d.offset().left+d.outerWidth()-i.tabSize||!i.rtl&&this.positionAbs.left>d.offset().left+i.tabSize)?(this._isAllowed(d,f,f+p+1),d.children(i.listType).length||d[0].appendChild(u),n&&n<=d.offset().top?d.children(i.listType).prepend(this.placeholder):d.children(i.listType)[0].appendChild(this.placeholder[0]),this._trigger("change",o,this._uiHash())):this._isAllowed(s,f,f+p),this._contactContainers(o),a.ui.ddmanager&&a.ui.ddmanager.drag(this,o),this._trigger("sort",o,this._uiHash()),this.lastPositionAbs=this.positionAbs,!1},_mouseStop:function(o,i){this.beyondMaxLevels&&(this.placeholder.removeClass(this.options.errorClass),this.domPosition.prev?a(this.domPosition.prev).after(this.placeholder):a(this.domPosition.parent).prepend(this.placeholder),this._trigger("revert",o,this._uiHash()));for(var e=this.items.length-1;e>=0;e--){var n=this.items[e].item[0];this._clearEmpty(n)}a.ui.sortable.prototype._mouseStop.apply(this,arguments)},serialize:function(o){var i=a.extend({},this.options,o),e=this._getItemsAsjQuery(i&&i.connected),n=[];return a(e).each(function(){var o=(a(i.item||this).attr(i.attribute||"id")||"").match(i.expression||/(.+)[-=_](.+)/),e=(a(i.item||this).parent(i.listType).parent(i.items).attr(i.attribute||"id")||"").match(i.expression||/(.+)[-=_](.+)/);o&&n.push((i.key||o[1])+"["+(i.key&&i.expression?o[1]:o[2])+"]="+(e?i.key&&i.expression?e[1]:e[2]:i.rootID))}),!n.length&&i.key&&n.push(i.key+"="),n.join("&")},toHierarchy:function(o){function i(o){var n=(a(o).attr(e.attribute||"id")||"").match(e.expression||/(.+)[-=_](.+)/);if(n){var t={id:n[2]};return a(o).children(e.listType).children(e.items).length>0&&(t.children=[],a(o).children(e.listType).children(e.items).each(function(){var a=i(this);t.children.push(a)})),t}}var e=a.extend({},this.options,o),n=(e.startDepthCount||0,[]);return a(this.element).children(e.items).each(function(){var a=i(this);n.push(a)}),n},toArray:function(o){function i(o,c,r){var l,s,f=r+1;if(a(o).children(e.listType).children(e.items).length>0&&(c++,a(o).children(e.listType).children(e.items).each(function(){f=i(a(this),c,f)}),c--),l=a(o).attr(e.attribute||"id").match(e.expression||/(.+)[-=_](.+)/),c===n+1)s=e.rootID;else{var p=a(o).parent(e.listType).parent(e.items).attr(e.attribute||"id").match(e.expression||/(.+)[-=_](.+)/);s=p[2]}return l&&t.push({item_id:l[2],parent_id:s,depth:c,left:r,right:f}),r=f+1}var e=a.extend({},this.options,o),n=e.startDepthCount||0,t=[],c=2;return t.push({item_id:e.rootID,parent_id:"none",depth:n,left:"1",right:2*(a(e.items,this.element).length+1)}),a(this.element).children(e.items).each(function(){c=i(this,n+1,c)}),t=t.sort(function(a,o){return a.left-o.left})},_clearEmpty:function(o){var i=a(o).children(this.options.listType);!i.length||i.children().length||this.options.doNotClear||i.remove()},_getLevel:function(a){var o=1;if(this.options.listType)for(var i=a.closest(this.options.listType);i&&i.length>0&&!i.is(".ui-sortable");)o++,i=i.parent().closest(this.options.listType);return o},_getChildLevels:function(o,i){var e=this,n=this.options,t=0;return i=i||0,a(o).children(n.listType).children(n.items).each(function(a,o){t=Math.max(e._getChildLevels(o,i+1),t)}),i?t+1:t},_isAllowed:function(o,i,e){var n=this.options,t=a(this.domPosition.parent).hasClass("ui-sortable")?!0:!1,c=this.placeholder.closest(".ui-sortable").nestedSortable("option","maxLevels");!n.isAllowed(this.placeholder,o)||o&&o.hasClass(n.disableNesting)||n.protectRoot&&(null==o&&!t||t&&i>1)?(this.placeholder.addClass(n.errorClass),e>c&&0!=c?this.beyondMaxLevels=e-c:this.beyondMaxLevels=1):e>c&&0!=c?(this.placeholder.addClass(n.errorClass),this.beyondMaxLevels=e-c):(this.placeholder.removeClass(n.errorClass),this.beyondMaxLevels=0)}})),a.mjs.nestedSortable.prototype.options=a.extend({},a.ui.sortable.prototype.options,a.mjs.nestedSortable.prototype.options)}(jQuery);
